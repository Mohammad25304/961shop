<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <link href="css/headphones.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // NAVIGATION SCROLLING EFFECT

        let navBar = document.querySelector("nav");
        navScroll(false);

        document.addEventListener("scroll", () => {
          navScroll(false);
        });

        function navScroll(result) {
          // result = if the user is currently viewing the menu page
          if (window.scrollY > 0 && !result) {
            navBar.style.boxShadow = "0 5px 20px rgba(190, 190, 190, 0.15)";
            navBar.style.backgroundColor = " #edf2fb";
          } else {
            navBar.style.boxShadow = "none";
            navBar.style.backgroundColor = "#edf2fb";
          }
        }

        // MENU BAR

        let menuBar = document.querySelector("#menu-bar");
        let menuPage = document.querySelector("#menu-page");
        let html = document.querySelector("html");

        // Determine Screen Device: Desktop or Mobile
        let menuBarStyle = window.getComputedStyle(menuBar);
        let screenType = "";

        if (menuBarStyle.display === "flex") {
          screenType = "mobile";
        } else if (menuBarStyle.display === "none") {
          screenType = "desktop";
        } else {
          console.log("Error: Failed to identify screen type", screenType);
        }

        // Show/Hide Menu Page

        menuBar.addEventListener("click", () => {
          menuPage.classList.toggle("active");

          html.style.overflow = menuPage.classList.contains("active")
            ? "hidden"
            : "scroll";
          navScroll(menuPage.classList.contains("active"));
        });

        // PRODUCT CARDS DISPLAY

        let productContainerWidth = document.querySelector(
          ".product-cards-container"
        ).offsetWidth;

        let rootStyles = getComputedStyle(html);
        let productCardWidth;
        let productCards;

        if (screenType === "desktop") {
          productCardWidth = parseInt(
            rootStyles
              .getPropertyValue("--product-card-width")
              .replace("px", "")
          );
          productCardsPerRow = Math.floor(
            productContainerWidth / (productCardWidth + 5)
          );
        } else if (screenType === "mobile") {
          productCardsPerRow = html.offsetWidth > 430 ? 3 : 2;
          productCardWidth = Math.floor(
            productContainerWidth / productCardsPerRow - 10
          );
        } else {
          console.log(
            "Error: Failed to set productCardsPerRow & productCardWidth"
          );
        }

        let marginSpacing =
          (productContainerWidth - productCardsPerRow * productCardWidth) /
          (productCardsPerRow - 1);
        let lastElement = productCardsPerRow - 1;

        let sectionLastElement = [];
        let productSections = document.querySelectorAll(".product-section");
        productSections.forEach((section) => {
          productCards = section.querySelectorAll(".product-card");

          for (let i = 0; i < productCardsPerRow; i++) {
            productCards[i].classList.add("active");

            if (i === lastElement) {
              productCards[i].style.marginRight = "0px";
            } else {
              productCards[i].style.marginRight = `${marginSpacing}px`;
            }
          }

          sectionLastElement[section.id] = lastElement;
        });

        // ADDING ITEMS TO WISHLIST

        let wishListCount;
        let heartButtons = document.querySelectorAll(".heart-button");

        heartButtons.forEach((button) => {
          button.addEventListener("click", () => {
            button.classList.toggle("active");

            wishListCount = accessCounter(".wishlist-link span");
            wishListCount.innerHTML = document.querySelectorAll(
              ".heart-button.active"
            ).length;
          });
        });

        // ADDING ITEMS TO CART

        let cartCount;
        let cartButtons = document.querySelectorAll(
          ".product-card .blue-button"
        );

        cartButtons.forEach((button) => {
          button.addEventListener("click", () => {
            button.classList.toggle("active");

            let buttonString = button.innerHTML.trim();
            if (buttonString == "Add To Cart") {
              button.innerHTML = "Remove";
            } else if (buttonString == "Remove") {
              button.innerHTML = "Add To Cart";
            } else {
              console.log(
                "Error: Adding items to cart failed.",
                buttonString,
                button.parentElement
              );
            }

            cartCount = accessCounter(".cart-link span");
            cartCount.innerHTML = document.querySelectorAll(
              ".product-card .blue-button.active"
            ).length;
          });
        });

        function accessCounter(spanElement) {
          if (screenType === "desktop") {
            return document
              .querySelector("#navbar-tools")
              .querySelector(spanElement);
          } else if (screenType === "mobile") {
            return document
              .querySelector("#menu-tools")
              .querySelector(spanElement);
          } else {
            console.log("Error: accessCounter Function failed.");
          }
        }

        // SLIDESHOW

        let slideshowButtons = document.querySelectorAll(".slideshow-button");
        slideshowButtons.forEach((button) => {
          button.addEventListener("click", () => {
            let slideshowSection = button.parentElement.dataset.slideshow;
            let slideshowContainer = document.querySelector(
              `#product-section-${slideshowSection}`
            );
            let productCards =
              slideshowContainer.querySelectorAll(".product-card");

            let currentSection = `product-section-${slideshowSection}`;
            if (button.classList.contains("prev-button")) {
              if (
                sectionLastElement[currentSection] <=
                productCardsPerRow - 1
              ) {
                sectionLastElement[currentSection] = productCards.length - 1;
              } else {
                sectionLastElement[currentSection]--;
              }
            } else if (button.classList.contains("next-button")) {
              if (
                sectionLastElement[currentSection] ===
                productCards.length - 1
              ) {
                sectionLastElement[currentSection] = productCardsPerRow - 1;
              } else {
                sectionLastElement[currentSection]++;
              }
            } else {
              console.log("Slideshow: Error occurred");
            }

            for (let i = 0; i < productCards.length; i++) {
              if (
                i <= sectionLastElement[currentSection] &&
                i >=
                  sectionLastElement[currentSection] - (productCardsPerRow - 1)
              ) {
                productCards[i].classList.add("active");

                if (i === sectionLastElement[currentSection]) {
                  productCards[i].style.marginRight = "0px";
                } else {
                  productCards[i].style.marginRight = `${marginSpacing}px`;
                }
              } else {
                productCards[i].classList.remove("active");
                productCards[i].style.marginRight = "0px";
              }
            }
          });
        });
      });
    </script>
  </head>
  </head>
  <body>
    <nav>
      <div id="navbar">
        <div id="navbar-logo">
          <img
            src="./images/961Tech.png"
            alt="961Tech, Company Ecommerce Logo"
            width="260"
            height="130"
          />
        </div>
        <div id="menu-bar">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            class="bi bi-list"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"
            />
          </svg>
        </div>
        <div id="navbar-links">
          <ul>
            <li>
              <a href="index.html"> Home </a>
            </li>
            <li>
              <a href="products.html"> Products </a>
              <ul class=" dropdown">
                <li><a href="electronics.html">Electronics</a></li>
                <li><a href="audio.html">Audio</a></li>
                <li><a href="wearables.html">Wearables</a></li>
                <li><a href="accessories.html">Accessories</a></li>

            </ul>
            </li>
            <li>
              <a href="#"> Services </a>
            </li>
            <li>
              <a href="#"> About </a>
            </li>
          </ul>

          <div class="search">
            <label for="search">Search:</label>
            <input type="search" id="search" name="search" placeholder="Search here...">
        </div>
          <div class="collection-tools" id="navbar-tools">
            <a class="cart-link" href="#">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                fill="currentColor"
                class="bi bi-bag"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1m3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z"
                />
              </svg>
              <span>0</span>
            </a>
            <a class="wishlist-link" href="#">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                fill="currentColor"
                class="bi bi-heart"
                viewBox="0 0 16 16"
              >
                <path
                  d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"
                />
              </svg>
              <span>0</span>
            </a>
          </div>
        </div>
      </div>
    </nav>


    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const storedProducts = localStorage.getItem("products");
      
        if (storedProducts) {
          const products = JSON.parse(storedProducts);
          const electronicsProducts = products.filter(
            (product) => product.category.toLowerCase() === "audio"
          );
          displayProducts(electronicsProducts);
      
          // Attach event listeners for rating inputs
          attachRatingListeners(products);
        } else {
          fetch("products.json")
            .then((response) => response.json())
            .then((products) => {
              localStorage.setItem("products", JSON.stringify(products));
              const electronicsProducts = products.filter(
                (product) => product.category.toLowerCase() === "audio"
              );
              displayProducts(electronicsProducts);
      
              // Attach event listeners for rating inputs
              attachRatingListeners(products);
            })
            .catch((error) => console.log("Error fetching products:", error));
        }
      
        function attachRatingListeners(products) {
          const ratingInputs = document.querySelectorAll('input[name="rate_product"]');
          ratingInputs.forEach((input) => {
            input.addEventListener("input", (event) => {
              const productId = input.id.split("-")[1]; // Extract product ID from input ID
              const newRating = parseFloat(event.target.value);
      
              // Update product rating in the products array
              const productIndex = products.findIndex((p) => p.id == productId);
              if (productIndex > -1) {
                products[productIndex].rating = newRating;
      
                // Update the local storage with the new rating
                localStorage.setItem("products", JSON.stringify(products));
                console.log(
                  `Updated rating for product ID ${productId} to ${newRating}`
                );
              }
            });
          });
        }
      });
      
    
        // Function to display products
        function displayProducts(products) {
          const productContainer = document.querySelector("#product-list"); // Assuming there's a div to hold the products
          productContainer.innerHTML = ""; // Clear existing content
    
          products.forEach((product) => {
            const productDiv = document.createElement("div");
            productDiv.classList.add("product");
    
            productDiv.innerHTML = `
              <div class="image_product">
                <img src="${product.image}" alt="${product.name}">
              </div>
              <div class="name_product">
                <h3>${product.name}</h3>
              </div>
              <div class="price_product">
                <h4>${product.price}$</h4>
              </div>
              <div class="desc_product">
                <p>${product.description}</p>
              </div>
              <div>
                <label for="qty-${product.id}">Quantity</label>
                <input type="number" name="qty" id="qty-${product.id}" min="1" max="10">
              </div>
              <label for="rate_product-${product.id}">Rate Product:</label>
              <input type="number" id="rate_product-${product.id}" name="rate_product" min="0" max="5" step="0.1" placeholder="0.0">
              <div class="add_to_cart">
                <a href="#">
                  <button type="button">Add To Cart</button>
                </a>
              </div>
            `;
    
            productContainer.appendChild(productDiv);
          });
        }
    
        // Search functionality for products
        document.getElementById("search").addEventListener("input", function () {
          const query = this.value.toLowerCase();
          const products = document.querySelectorAll(".product");
    
          products.forEach((product) => {
            const name = product.querySelector(".name_product h3").textContent.toLowerCase();
            const description = product.querySelector(".desc_product p").textContent.toLowerCase();
    
            if (name.includes(query) || description.includes(query)) {
              product.style.display = "block";
            } else {
              product.style.display = "none";
            }
          });
        });

        localStorage.setItem("products", JSON.stringify(products));


        function addToCart(id) {
          const LoggedInUser = localStorage.getItem("Loggedinuser");
        
          // Find the product by its ID
          const product = productsData.find((p) => p.id === id);
          if (!product) {
            console.error("Product not found!");
            return;
          }
        
          // Retrieve the existing cart from localStorage
          const existingCart = localStorage.getItem("cart");
          let cart = existingCart ? JSON.parse(existingCart) : [];
        
          // Check if the user has a cart
          let userCart = cart.find((c) => c.user_id === LoggedInUser);
          if (!userCart) {
            userCart = {
              user_id: LoggedInUser,
              items: [],
              summary: {
                total_items: 0,
                total_price_before_discount: 0,
                total_discount: 0,
                total_price_after_discount: 0,
                delivery_fee: 15.0,
                taxes: 17.52,
                final_total: 0,
              },
            };
            cart.push(userCart);
          }
        
          if (product.is_bundle) {
            // Handle bundle products
            let bundleProducts = [];
            let totalBundlePrice = 0;
        
            product.bundle_items.forEach((bundleItemId) => {
              const bundleProduct = productsData.find((prod) => prod.id === bundleItemId);
              if (bundleProduct) {
                const discountedPrice = bundleProduct.price * (1 - parseInt(product.discount) / 100);
                totalBundlePrice += discountedPrice;
        
                // Add individual bundle items with their details
                bundleProducts.push({
                  id: bundleProduct.id,
                  name: bundleProduct.name,
                  image: bundleProduct.image,
                  price: bundleProduct.price,
                  discounted_price: discountedPrice.toFixed(2),
                  discount: product.discount,
                  category: bundleProduct.category,
                  quantity: 1,
                });
              }
            });
        
            const bundleEntry = {
              id: product.id,
              name: product.name,
              image: product.image,
              price: product.price,
              discounted_price: totalBundlePrice.toFixed(2),
              discount: product.discount,
              category: product.category,
              quantity: 1,
              bundle_items: bundleProducts,
              subtotal: totalBundlePrice.toFixed(2),
            };
        
            userCart.items.push(bundleEntry);
          } else {
            // Handle individual products
            const existingItem = userCart.items.find((item) => item.id === id);
            const discountedPrice = product.price * (1 - parseInt(product.discount || 0) / 100);
        
            if (existingItem) {
              // Update quantity and subtotal for the existing product
              existingItem.quantity += 1;
              existingItem.subtotal = (existingItem.discounted_price * existingItem.quantity).toFixed(2);
            } else {
              // Add the product to the cart as a new entry
              userCart.items.push({
                id: product.id,
                name: product.name,
                image: product.image,
                price: product.price,
                discounted_price: discountedPrice.toFixed(2),
                discount: product.discount || 0,
                category: product.category,
                quantity: 1,
                subtotal: discountedPrice.toFixed(2),
              });
            }
          }
        
          // Update the cart summary after adding the item
          updateCartSummary(userCart);
        
          // Save the updated cart to localStorage
          localStorage.setItem("cart", JSON.stringify(cart));
        
          console.log(`${product.name} added to cart.`);
        
          // Disable the button for the added bundle
          const addButton = document.getElementById(`add-btn-${id}`);
          if (addButton) {
            addButton.disabled = true;
            addButton.textContent = "Added to Cart";
          }
        }
        
        function updateCartSummary(userCart) {
          let totalItems = 0;
          let totalPriceBeforeDiscount = 0;
          let totalDiscount = 0;
          let totalPriceAfterDiscount = 0;
          const deliveryFee = 15.0;
          const taxes = 17.52;
        
          userCart.items.forEach((item) => {
            const itemQuantity = item.bundle_items ? item.bundle_items.length * item.quantity : item.quantity;
            const itemPriceBeforeDiscount = item.bundle_items
              ? item.bundle_items.reduce((sum, p) => sum + p.price * item.quantity, 0)
              : item.price * item.quantity;
            const itemDiscount = item.bundle_items
              ? item.bundle_items.reduce(
                  (sum, p) => sum + ((p.price * (parseFloat(p.discount) || 0)) / 100) * item.quantity,
                  0
                )
              : ((item.price * (parseFloat(item.discount) || 0)) / 100) * item.quantity;
            const itemPriceAfterDiscount = parseFloat(item.subtotal);
        
            totalItems += itemQuantity;
            totalPriceBeforeDiscount += itemPriceBeforeDiscount;
            totalDiscount += itemDiscount;
            totalPriceAfterDiscount += itemPriceAfterDiscount;
          });
        
          const finalTotal = totalPriceAfterDiscount + deliveryFee + taxes;
        
          userCart.summary = {
            total_items: totalItems,
            total_price_before_discount: totalPriceBeforeDiscount.toFixed(2),
            total_discount: totalDiscount.toFixed(2),
            total_price_after_discount: totalPriceAfterDiscount.toFixed(2),
            delivery_fee: deliveryFee.toFixed(2),
            taxes: taxes.toFixed(2),
            final_total: finalTotal.toFixed(2),
          };
        }
    </script>
  </head>
  <body>
    <nav>
      <!-- Add your navbar content here -->
    </nav>

    <div class="header">
      <h2>Audio</h2>
    </div>

    <div class="container">
      <div id="product-list" class="product-list">
        <!-- Products will be dynamically inserted here -->
      </div>
    </div>
  </head>
  <body>
    <nav>
      <!-- Add your navbar content here -->
    </nav>



</body>
</html>